68K GAS  ExtRAMTest.s 			page 1


   1               	* =======================================================================
   2               	* Test the External SRAM on the RETRO-EP4CE15 card
   3               	* The RETRO-EP4CE15 card has 1MB of External SRAM
   4               	* External SRAM only supports 8-bit accesses
   5               	* External SRAM goes from 0x300000 to 0x3FFFFF (1 MB)
   6               	* Test checks the physical connections to the SRAM
   7               	* Test does not exhaustively check the SRAM itself
   8               	* Test takes several seconds with a 25 MHz 68000 CPU
   9               	* TUTOR14 uses SRAM from 0x000000 to 0x000800
  10               	* =======================================================================
  11               	
  12               	RAMSTART	= 0x300000
  13               	RAMEND		= 0x3FFFFF
  14               	ACIASTAT	= 0x010041
  15               	ACIADATA	= 0x010043
  16               	
  17               	* Code follows
  18               	
  19 0000 0000 0000 		.ORG    0x001000
  19      0000 0000 
  19      0000 0000 
  19      0000 0000 
  19      0000 0000 
  20               	* CHECK FIRST LOCATION BY WRITING/READING 0x55/0xAA
  21               	* VERY ROUGH CHECK OF DATA LINES
  22               	* DATA LINES COULD STILL HAVE SHORTS BUT LESS LIKELY SINCE PINS ARE ADJACENT
  23               	STARTTEST:
  24 1000 207C 0030 		MOVE.L  #RAMSTART,%A0
  24      0000 
  25 1006 103C 0055 		MOVE.B  #0x55,%D0
  26 100a 1080      		MOVE.B	%D0,(%A0)
  27 100c 1210      	    MOVE.B	(%A0),%D1
  28 100e B200      	    CMP.B   %D0,%D1
  29 1010 6600 014C 	    BNE     FAIL
  30 1014 103C 00AA 		MOVE.B  #0xAA,%D0
  31 1018 1080      		MOVE.B	%D0,(%A0)
  32 101a 4E71      	    NOP
  33 101c 1210      	    MOVE.B	(%A0),%D1
  34 101e B200      	    CMP.B   %D0,%D1
  35 1020 6600 013C 	    BNE     FAIL
  36               	
  37               	* BOUNCE A 1 ACROSS THE DATA LINES
  38               	* THIS VERIFIES THERE ARE NO SHORTED DATA LINES
  39               	* ADDRESS LINES COULD STILL HAVE SHORTS/OPENS
  40               	BOUNCE1S:
  41 1024 207C 0030 		MOVE.L  #RAMSTART,%A0
  41      0000 
  42 102a 103C 0001 		MOVE.B  #0x01,%D0
  43               	NEXTONE:
  44 102e 1080      		MOVE.B	%D0,(%A0)
  45 1030 1210      	    MOVE.B  (%A0),%D1
  46 1032 B200      	    CMP.B   %D0,%D1
  47 1034 6600 0128 	    BNE     FAIL
  48 1038 E380      	    ASL.L   #1,%D0
  49 103a 0C00 0000 	    CMP.B   #0,%D0
  50 103e 6600 FFEE 	    BNE     NEXTONE
  51               	
68K GAS  ExtRAMTest.s 			page 2


  52               	* CHECK THE UPPER 8 SRAM ADDRESS LINES (A12..A19 ON SRAM)
  53               	* SINCE THERE ARE ONLY 8 DATA LINES THERE CAN ONLY BE 256 UNIQUE DATA PATTERNS
  54               	* WRITE AN INCREMENTING VALUE EVERY 4096 BYTES AND VERIFY
  55 1042 103C 0000 	    MOVE.B  #0X00,%D0
  56 1046 207C 0030 		MOVE.L  #RAMSTART,%A0
  56      0000 
  57 104c 227C 0040 		MOVE.L  #RAMEND+1,%A1
  57      0000 
  58               	FILL4K:
  59 1052 1080      	    MOVE.B  %D0,(%A0)
  60 1054 06B9 0000 	    ADDI.L  #4096,A0
  60      1000 0000 
  60      0000 
  61 105e B3C8      	    CMP.L   %A0,%A1
  62 1060 6C08      	    BGE.S   DONE4KFL
  63 1062 0600 0001 	    ADDI.B  #0x01,%D0
  64 1066 6000 FFEA 	    BRA     FILL4K
  65               	DONE4KFL:
  66 106a 103C 0000 	    MOVE.B  #0X00,%D0
  67 106e 207C 0030 		MOVE.L  #RAMSTART,%A0
  67      0000 
  68 1074 227C 0040 		MOVE.L  #RAMEND+1,%A1
  68      0000 
  69               	CHK4K:
  70 107a 1210      	    MOVE.B  (%A0),%D1
  71 107c B200      	    CMP.B   %D0,%D1
  72 107e 6600 00DE 	    BNE     FAIL
  73 1082 0600 0001 	    ADDI.B  #0x01,%D0
  74 1086 06B9 0000 	    ADDI.L  #4096,A0
  74      1000 0000 
  74      0000 
  75 1090 B3C8      	    CMP.L   %A0,%A1
  76 1092 6C04      	    BGE.S   DONE4K
  77 1094 6000 FFE4 	    BRA     CHK4K
  78               	DONE4K:
  79               	
  80               	* CHECK NEXT 4 SRAM ADDRESS LINES (A8..A11 ON SRAM)
  81               	* A12-A19 = 0
  82               	* WRITE AN INCREMENTING VALUE EVERY 256 BYTES AND VERIFY
  83               	* ONLY NEED 16 UNIQUE PATTERNS FOR 4 BITS
  84 1098 103C 0000 	    MOVE.B  #0X00,%D0
  85 109c 207C 0030 		MOVE.L  #RAMSTART,%A0
  85      0000 
  86 10a2 227C 0030 		MOVE.L  #RAMSTART+0x1000,%A1
  86      1000 
  87               	FILL256:
  88 10a8 1080      	    MOVE.B  %D0,(%A0)
  89 10aa 06B9 0000 	    ADDI.L  #256,A0
  89      0100 0000 
  89      0000 
  90 10b4 B3C8      	    CMP.L   %A0,%A1
  91 10b6 6C08      	    BGE.S   DONE256F
  92 10b8 0600 0001 	    ADDI.B  #0x01,%D0
  93 10bc 6000 FFEA 	    BRA     FILL256
  94               	DONE256F:
  95 10c0 103C 0000 	    MOVE.B  #0X00,%D0
  96 10c4 207C 0030 		MOVE.L  #RAMSTART,%A0
68K GAS  ExtRAMTest.s 			page 3


  96      0000 
  97 10ca 227C 0030 		MOVE.L  #RAMSTART+0x1000,%A1
  97      1000 
  98               	CHK256:
  99 10d0 1210      	    MOVE.B  (%A0),%D1
 100 10d2 B200      	    CMP.B   %D0,%D1
 101 10d4 6600 0088 	    BNE     FAIL
 102 10d8 0600 0001 	    ADDI.B  #0x01,%D0
 103 10dc 06B9 0000 	    ADDI.L  #256,A0
 103      0100 0000 
 103      0000 
 104 10e6 B3C8      	    CMP.L   %A0,%A1
 105 10e8 6C04      	    BGE.S   DONE256
 106 10ea 6000 FFE4 	    BRA     CHK256
 107               	DONE256:
 108               	
 109               	* WRITE INCREMENTING PATTERN TO ALL THE SRAM
 110               	* CHECKS THE REMAINING BOTTOM ADDRESSES LINES
 111               	* TOKEN EFFORT TO TOUCH ALL LOCATIONS
 112               	* MAY NOT DETECT INDIVIDUAL STUCK AT HIGH OR LOW BITS INSIDE SRAM
 113 10ee 103C 0000 	    MOVE.B  #0X00,%D0
 114 10f2 207C 0030 		MOVE.L  #RAMSTART,%A0
 114      0000 
 115 10f8 227C 0040 		MOVE.L  #RAMEND+1,%A1
 115      0000 
 116               	CHKALL:
 117 10fe 10C0      	    MOVE.B  %D0,(%A0)+
 118 1100 B3C8      	    CMP.L   %A0,%A1
 119 1102 6706      	    BEQ.S   DONEFILL
 120 1104 0600 0001 	    ADDI.B  #0x01,%D0
 121 1108 60F4      	    BRA.S   CHKALL
 122               	DONEFILL:
 123               	* READ BACK INCREMENTING PATTERN 
 124 110a 103C 0000 	    MOVE.B  #0X00,%D0
 125 110e 207C 0030 		MOVE.L  #RAMSTART,%A0
 125      0000 
 126 1114 227C 0040 		MOVE.L  #RAMEND+1,%A1
 126      0000 
 127               	LOOPCHK:
 128 111a 1218      	    MOVE.B  (%A0)+,%D1
 129 111c B200      	    CMP.B   %D0,%D1
 130 111e 6600 003E 	    BNE     FAIL
 131 1122 B3C8      	    CMP.L   %A0,%A1
 132 1124 6706      	    BEQ.S   DONECHK
 133 1126 0600 0001 	    ADDI.B  #0x01,%D0
 134 112a 60EE      	    BRA.S   LOOPCHK
 135               	DONECHK:
 136               	
 137               	* PRINT 'Pass'
 138 112c 103C 000A 		MOVE.B	#0x0A,%D0
 139 1130 4EBA 005E 		JSR     OUTCHAR
 140 1134 103C 000D 		MOVE.B	#0x0D,%D0
 141 1138 4EBA 0056 		JSR     OUTCHAR
 142 113c 103C 0050 		MOVE.B	#'P',%D0
 143 1140 4EBA 004E 		JSR     OUTCHAR
 144 1144 103C 0061 		MOVE.B	#'a',%D0
 145 1148 4EBA 0046 		JSR     OUTCHAR
68K GAS  ExtRAMTest.s 			page 4


 146 114c 103C 0073 		MOVE.B	#'s',%D0
 147 1150 4EBA 003E 		JSR     OUTCHAR
 148 1154 103C 0073 		MOVE.B	#'s',%D0
 149 1158 4EBA 0036 		JSR     OUTCHAR
 150 115c 4E75      	    RTS
 151               	FAIL:
 152               	* PRINT 'Fail'
 153 115e 103C 000A 		MOVE.B	#0x0A,%D0
 154 1162 4EBA 002C 		JSR     OUTCHAR
 155 1166 103C 000D 		MOVE.B	#0x0D,%D0
 156 116a 4EBA 0024 		JSR     OUTCHAR
 157 116e 103C 0046 		MOVE.B	#'F',%D0
 158 1172 4EBA 001C 		JSR     OUTCHAR
 159 1176 103C 0061 		MOVE.B	#'a',%D0
 160 117a 4EBA 0014 		JSR     OUTCHAR
 161 117e 103C 0069 		MOVE.B	#'i',%D0
 162 1182 4EBA 000C 		JSR     OUTCHAR
 163 1186 103C 006C 		MOVE.B	#'l',%D0
 164 118a 4EBA 0004 		JSR     OUTCHAR
 165 118e 4E75      		RTS
 166               	
 167               	* OUTPUT A CHARACTER IN D0 TO THE ACIA
 168               	OUTCHAR:
 169 1190 610A      	    BSR.S   WAITRDY
 170 1192 43F9 0001 	    LEA     ACIADATA,%A1
 170      0043 
 171 1198 1280      		MOVE.B	%D0,(%A1)
 172 119a 4E75      	    RTS
 173               	
 174               	* WAIT FOR THE SERIAL PORT TO BE READY
 175               	WAITRDY:
 176 119c 43F9 0001 		LEA     ACIASTAT,%A1
 176      0041 
 177               	LOOPRDY:
 178 11a2 1211      		MOVE.B	(%A1),%D1
 179 11a4 0201 0002 		ANDI.B	#0x2,%D1
 180 11a8 67F8      		BEQ.S   LOOPRDY
 181 11aa 4E75      	    RTS
 182               	
68K GAS  ExtRAMTest.s 			page 5


DEFINED SYMBOLS
        ExtRAMTest.s:12     *ABS*:0000000000300000 RAMSTART
        ExtRAMTest.s:13     *ABS*:00000000003fffff RAMEND
        ExtRAMTest.s:14     *ABS*:0000000000010041 ACIASTAT
        ExtRAMTest.s:15     *ABS*:0000000000010043 ACIADATA
        ExtRAMTest.s:23     .text:0000000000001000 STARTTEST
        ExtRAMTest.s:151    .text:000000000000115e FAIL
        ExtRAMTest.s:40     .text:0000000000001024 BOUNCE1S
        ExtRAMTest.s:43     .text:000000000000102e NEXTONE
        ExtRAMTest.s:58     .text:0000000000001052 FILL4K
        ExtRAMTest.s:65     .text:000000000000106a DONE4KFL
        ExtRAMTest.s:69     .text:000000000000107a CHK4K
        ExtRAMTest.s:78     .text:0000000000001098 DONE4K
        ExtRAMTest.s:87     .text:00000000000010a8 FILL256
        ExtRAMTest.s:94     .text:00000000000010c0 DONE256F
        ExtRAMTest.s:98     .text:00000000000010d0 CHK256
        ExtRAMTest.s:107    .text:00000000000010ee DONE256
        ExtRAMTest.s:116    .text:00000000000010fe CHKALL
        ExtRAMTest.s:122    .text:000000000000110a DONEFILL
        ExtRAMTest.s:127    .text:000000000000111a LOOPCHK
        ExtRAMTest.s:135    .text:000000000000112c DONECHK
        ExtRAMTest.s:168    .text:0000000000001190 OUTCHAR
        ExtRAMTest.s:175    .text:000000000000119c WAITRDY
        ExtRAMTest.s:177    .text:00000000000011a2 LOOPRDY

UNDEFINED SYMBOLS
A0
