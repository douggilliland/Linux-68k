68K GAS  ExtRAMTest.s 			page 1


   1               	* =======================================================================
   2               	* Test the External SRAM on the RETRO-EP4CE15 card
   3               	* The RETRO-EP4CE15 card has 1MB of External SRAM
   4               	* External SRAM only supports 8-bit accesses
   5               	* External SRAM goes from 0x300000 to 0x3FFFFF (1 MB)
   6               	* Test checks the physical connections to the SRAM
   7               	* Test does not exhaustively check the SRAM itself
   8               	* Test takes 2.46 seconds with a 25 MHz 68000 CPU
   9               	* TUTOR14 uses SRAM from 0x000000 to 0x0007FF
  10               	* =======================================================================
  11               	
  12               	RAMSTART	= 0x300000
  13               	RAMEND		= 0x3FFFFF
  14               	ACIASTAT	= 0x010041
  15               	ACIADATA	= 0x010043
  16               	
  17               	* Code follows
  18               	
  19 0000 0000 0000 		.ORG    0x001000
  19      0000 0000 
  19      0000 0000 
  19      0000 0000 
  19      0000 0000 
  20               	* CHECK FIRST LOCATION BY WRITING/READING 0x55/0xAA
  21               	* VERY ROUGH CHECK OF DATA LINES
  22               	* DATA LINES COULD STILL HAVE SHORTS BUT LESS LIKELY SINCE PINS ARE ADJACENT
  23               	STARTTEST:
  24 1000 207C 0030 		MOVE.L  #RAMSTART,%A0
  24      0000 
  25 1006 7055      		MOVEQ   #0x55,%D0
  26 1008 1080      		MOVE.B	%D0,(%A0)
  27 100a 1210      	    MOVE.B	(%A0),%D1
  28 100c B200      	    CMP.B   %D0,%D1
  29 100e 6600 0166 	    BNE     FAIL
  30 1012 103C 00AA 		MOVE.B  #0xAA,%D0
  31 1016 1080      		MOVE.B	%D0,(%A0)
  32 1018 4E71      	    NOP
  33 101a 1210      	    MOVE.B	(%A0),%D1
  34 101c B200      	    CMP.B   %D0,%D1
  35 101e 6600 0156 	    BNE     FAIL
  36               	
  37               	* BOUNCE A 1 ACROSS THE DATA LINES
  38               	* THIS VERIFIES THERE ARE NO SHORTED DATA LINES
  39               	* ADDRESS LINES COULD STILL HAVE SHORTS/OPENS
  40               	BOUNCE1S:
  41 1022 207C 0030 		MOVE.L  #RAMSTART,%A0
  41      0000 
  42 1028 7001      		MOVEQ   #0x01,%D0
  43               	NEXTONE:
  44 102a 1080      		MOVE.B	%D0,(%A0)
  45 102c 1210      	    MOVE.B  (%A0),%D1
  46 102e B200      	    CMP.B   %D0,%D1
  47 1030 6600 0144 	    BNE     FAIL
  48 1034 E380      	    ASL.L   #1,%D0
  49 1036 0C00 0000 	    CMP.B   #0,%D0
  50 103a 6600 FFEE 	    BNE     NEXTONE
  51               	
68K GAS  ExtRAMTest.s 			page 2


  52               	* BOUNCE A 0 ACROSS THE DATA LINES
  53               	BOUNCE0S:
  54 103e 207C 0030 		MOVE.L  #RAMSTART,%A0
  54      0000 
  55 1044 103C 00FE 		MOVE.B  #0xFE,%D0
  56               	NEXTZERO:
  57 1048 1080      		MOVE.B	%D0,(%A0)
  58 104a 1210      	    MOVE.B  (%A0),%D1
  59 104c B200      	    CMP.B   %D0,%D1
  60 104e 6600 0126 	    BNE     FAIL
  61 1052 E318      	    ROL.B   #0x1,%D0
  62               	*    ORI.B   #0x01,%D0
  63 1054 0C00 00FE 	    CMP.B   #0xFE,%D0
  64 1058 6600 FFEE 	    BNE     NEXTZERO
  65               	
  66               	* CHECK THE UPPER 8 SRAM ADDRESS LINES (A12..A19 ON SRAM)
  67               	* SINCE THERE ARE ONLY 8 DATA LINES THERE CAN ONLY BE 256 UNIQUE DATA PATTERNS
  68               	* WRITE AN INCREMENTING VALUE EVERY 4096 BYTES AND VERIFY
  69 105c 103C 0000 	    MOVE.B  #0X00,%D0
  70 1060 207C 0030 		MOVE.L  #RAMSTART,%A0
  70      0000 
  71 1066 227C 0040 		MOVE.L  #RAMEND+1,%A1
  71      0000 
  72               	FILL4K:
  73 106c 1080      	    MOVE.B  %D0,(%A0)
  74 106e 06B9 0000 	    ADDI.L  #4096,A0
  74      1000 0000 
  74      0000 
  75 1078 B3C8      	    CMP.L   %A0,%A1
  76 107a 6C08      	    BGE.S   DONE4KFL
  77 107c 0600 0001 	    ADDI.B  #0x01,%D0
  78 1080 6000 FFEA 	    BRA     FILL4K
  79               	DONE4KFL:
  80 1084 7000      	    MOVEQ   #0X00,%D0
  81 1086 207C 0030 		MOVE.L  #RAMSTART,%A0
  81      0000 
  82 108c 227C 0040 		MOVE.L  #RAMEND+1,%A1
  82      0000 
  83               	CHK4K:
  84 1092 1210      	    MOVE.B  (%A0),%D1
  85 1094 B200      	    CMP.B   %D0,%D1
  86 1096 6600 00DE 	    BNE     FAIL
  87 109a 0600 0001 	    ADDI.B  #0x01,%D0
  88 109e 06B9 0000 	    ADDI.L  #4096,A0
  88      1000 0000 
  88      0000 
  89 10a8 B3C8      	    CMP.L   %A0,%A1
  90 10aa 6C04      	    BGE.S   DONE4K
  91 10ac 6000 FFE4 	    BRA     CHK4K
  92               	DONE4K:
  93               	
  94               	* CHECK NEXT 4 SRAM ADDRESS LINES (A8..A11 ON SRAM)
  95               	* A12-A19 = 0
  96               	* WRITE AN INCREMENTING VALUE EVERY 256 BYTES AND VERIFY
  97               	* ONLY NEED 16 UNIQUE PATTERNS FOR 4 BITS
  98 10b0 103C 0000 	    MOVE.B  #0X00,%D0
  99 10b4 207C 0030 		MOVE.L  #RAMSTART,%A0
68K GAS  ExtRAMTest.s 			page 3


  99      0000 
 100 10ba 227C 0030 		MOVE.L  #RAMSTART+0x1000,%A1
 100      1000 
 101               	FILL256:
 102 10c0 1080      	    MOVE.B  %D0,(%A0)
 103 10c2 06B9 0000 	    ADDI.L  #256,A0
 103      0100 0000 
 103      0000 
 104 10cc B3C8      	    CMP.L   %A0,%A1
 105 10ce 6C08      	    BGE.S   DONE256F
 106 10d0 0600 0001 	    ADDI.B  #0x01,%D0
 107 10d4 6000 FFEA 	    BRA     FILL256
 108               	DONE256F:
 109 10d8 103C 0000 	    MOVE.B  #0X00,%D0
 110 10dc 207C 0030 		MOVE.L  #RAMSTART,%A0
 110      0000 
 111 10e2 227C 0030 		MOVE.L  #RAMSTART+0x1000,%A1
 111      1000 
 112               	CHK256:
 113 10e8 1210      	    MOVE.B  (%A0),%D1
 114 10ea B200      	    CMP.B   %D0,%D1
 115 10ec 6600 0088 	    BNE     FAIL
 116 10f0 0600 0001 	    ADDI.B  #0x01,%D0
 117 10f4 06B9 0000 	    ADDI.L  #256,A0
 117      0100 0000 
 117      0000 
 118 10fe B3C8      	    CMP.L   %A0,%A1
 119 1100 6C04      	    BGE.S   DONE256
 120 1102 6000 FFE4 	    BRA     CHK256
 121               	DONE256:
 122               	
 123               	* WRITE INCREMENTING PATTERN TO ALL THE SRAM
 124               	* CHECKS THE REMAINING BOTTOM ADDRESSES LINES
 125               	* TOKEN EFFORT TO TOUCH ALL LOCATIONS
 126               	* MAY NOT DETECT INDIVIDUAL STUCK AT HIGH OR LOW BITS INSIDE SRAM
 127 1106 103C 0000 	    MOVE.B  #0X00,%D0
 128 110a 207C 0030 		MOVE.L  #RAMSTART,%A0
 128      0000 
 129 1110 227C 0040 		MOVE.L  #RAMEND+1,%A1
 129      0000 
 130               	CHKALL:
 131 1116 10C0      	    MOVE.B  %D0,(%A0)+
 132 1118 B3C8      	    CMP.L   %A0,%A1
 133 111a 6706      	    BEQ.S   DONEFILL
 134 111c 0600 0001 	    ADDI.B  #0x01,%D0
 135 1120 60F4      	    BRA.S   CHKALL
 136               	DONEFILL:
 137               	* READ BACK INCREMENTING PATTERN 
 138 1122 103C 0000 	    MOVE.B  #0X00,%D0
 139 1126 207C 0030 		MOVE.L  #RAMSTART,%A0
 139      0000 
 140 112c 227C 0040 		MOVE.L  #RAMEND+1,%A1
 140      0000 
 141               	LOOPCHK:
 142 1132 1218      	    MOVE.B  (%A0)+,%D1
 143 1134 B200      	    CMP.B   %D0,%D1
 144 1136 6600 003E 	    BNE     FAIL
68K GAS  ExtRAMTest.s 			page 4


 145 113a B3C8      	    CMP.L   %A0,%A1
 146 113c 6706      	    BEQ.S   DONECHK
 147 113e 0600 0001 	    ADDI.B  #0x01,%D0
 148 1142 60EE      	    BRA.S   LOOPCHK
 149               	DONECHK:
 150               	
 151               	* PRINT 'Pass'
 152 1144 103C 000A 		MOVE.B	#0x0A,%D0
 153 1148 4EBA 005E 		JSR     OUTCHAR
 154 114c 103C 000D 		MOVE.B	#0x0D,%D0
 155 1150 4EBA 0056 		JSR     OUTCHAR
 156 1154 103C 0050 		MOVE.B	#'P',%D0
 157 1158 4EBA 004E 		JSR     OUTCHAR
 158 115c 103C 0061 		MOVE.B	#'a',%D0
 159 1160 4EBA 0046 		JSR     OUTCHAR
 160 1164 103C 0073 		MOVE.B	#'s',%D0
 161 1168 4EBA 003E 		JSR     OUTCHAR
 162 116c 103C 0073 		MOVE.B	#'s',%D0
 163 1170 4EBA 0036 		JSR     OUTCHAR
 164 1174 4E75      	    RTS
 165               	FAIL:
 166               	* PRINT 'Fail'
 167 1176 103C 000A 		MOVE.B	#0x0A,%D0
 168 117a 4EBA 002C 		JSR     OUTCHAR
 169 117e 103C 000D 		MOVE.B	#0x0D,%D0
 170 1182 4EBA 0024 		JSR     OUTCHAR
 171 1186 103C 0046 		MOVE.B	#'F',%D0
 172 118a 4EBA 001C 		JSR     OUTCHAR
 173 118e 103C 0061 		MOVE.B	#'a',%D0
 174 1192 4EBA 0014 		JSR     OUTCHAR
 175 1196 103C 0069 		MOVE.B	#'i',%D0
 176 119a 4EBA 000C 		JSR     OUTCHAR
 177 119e 103C 006C 		MOVE.B	#'l',%D0
 178 11a2 4EBA 0004 		JSR     OUTCHAR
 179 11a6 4E75      		RTS
 180               	
 181               	* OUTPUT A CHARACTER IN D0 TO THE ACIA
 182               	OUTCHAR:
 183 11a8 610A      	    BSR.S   WAITRDY
 184 11aa 43F9 0001 	    LEA     ACIADATA,%A1
 184      0043 
 185 11b0 1280      		MOVE.B	%D0,(%A1)
 186 11b2 4E75      	    RTS
 187               	
 188               	* WAIT FOR THE SERIAL PORT TO BE READY
 189               	WAITRDY:
 190 11b4 43F9 0001 		LEA     ACIASTAT,%A1
 190      0041 
 191               	LOOPRDY:
 192 11ba 1211      		MOVE.B	(%A1),%D1
 193 11bc 0201 0002 		ANDI.B	#0x2,%D1
 194 11c0 67F8      		BEQ.S   LOOPRDY
 195 11c2 4E75      	    RTS
 196               	
68K GAS  ExtRAMTest.s 			page 5


DEFINED SYMBOLS
        ExtRAMTest.s:12     *ABS*:0000000000300000 RAMSTART
        ExtRAMTest.s:13     *ABS*:00000000003fffff RAMEND
        ExtRAMTest.s:14     *ABS*:0000000000010041 ACIASTAT
        ExtRAMTest.s:15     *ABS*:0000000000010043 ACIADATA
        ExtRAMTest.s:23     .text:0000000000001000 STARTTEST
        ExtRAMTest.s:165    .text:0000000000001176 FAIL
        ExtRAMTest.s:40     .text:0000000000001022 BOUNCE1S
        ExtRAMTest.s:43     .text:000000000000102a NEXTONE
        ExtRAMTest.s:53     .text:000000000000103e BOUNCE0S
        ExtRAMTest.s:56     .text:0000000000001048 NEXTZERO
        ExtRAMTest.s:72     .text:000000000000106c FILL4K
        ExtRAMTest.s:79     .text:0000000000001084 DONE4KFL
        ExtRAMTest.s:83     .text:0000000000001092 CHK4K
        ExtRAMTest.s:92     .text:00000000000010b0 DONE4K
        ExtRAMTest.s:101    .text:00000000000010c0 FILL256
        ExtRAMTest.s:108    .text:00000000000010d8 DONE256F
        ExtRAMTest.s:112    .text:00000000000010e8 CHK256
        ExtRAMTest.s:121    .text:0000000000001106 DONE256
        ExtRAMTest.s:130    .text:0000000000001116 CHKALL
        ExtRAMTest.s:136    .text:0000000000001122 DONEFILL
        ExtRAMTest.s:141    .text:0000000000001132 LOOPCHK
        ExtRAMTest.s:149    .text:0000000000001144 DONECHK
        ExtRAMTest.s:182    .text:00000000000011a8 OUTCHAR
        ExtRAMTest.s:189    .text:00000000000011b4 WAITRDY
        ExtRAMTest.s:191    .text:00000000000011ba LOOPRDY

UNDEFINED SYMBOLS
A0
