68K GAS  ExtRAMTest.s 			page 1


   1               	* =======================================================================
   2               	* Test the External SRAM on the RETRO-EP4CE15 card
   3               	* The RETRO-EP4CE15 card has 1MB of External SRAM
   4               	* External SRAM only supports 8-bit accesses
   5               	* External SRAM goes from 0x300000 to 0x3FFFFF (1 MB)
   6               	* Test checks the physical connections to the SRAM
   7               	* Test does not exhaustively check the SRAM itself
   8               	* Test takes 2.46 seconds with a 25 MHz 68000 CPU
   9               	* TUTOR14 uses SRAM from 0x000000 to 0x0007FF
  10               	* =======================================================================
  11               	
  12               	RAMSTART	= 0x300000
  13               	RAMEND		= 0x3FFFFF
  14               	ACIASTAT	= 0x010041
  15               	ACIADATA	= 0x010043
  16               	
  17               	* Code follows
  18               	
  19 0000 0000 0000 		.ORG    0x001000
  19      0000 0000 
  19      0000 0000 
  19      0000 0000 
  19      0000 0000 
  20               	* CHECK FIRST LOCATION BY WRITING/READING 0x55/0xAA
  21               	* VERY ROUGH CHECK OF DATA LINES
  22               	* DATA LINES COULD STILL HAVE SHORTS BUT LESS LIKELY SINCE PINS ARE ADJACENT
  23               	STARTTEST:
  24 1000 207C 0030 		MOVE.L  #RAMSTART,%A0
  24      0000 
  25 1006 7055      		MOVEQ   #0x55,%D0
  26 1008 1080      		MOVE.B	%D0,(%A0)
  27 100a 1210      	    MOVE.B	(%A0),%D1
  28 100c B200      	    CMP.B   %D0,%D1
  29 100e 6600 0150 	    BNE.W   FAIL
  30 1012 103C 00AA 		MOVE.B  #0xAA,%D0
  31 1016 1080      		MOVE.B	%D0,(%A0)
  32 1018 4E71      	    NOP
  33 101a 1210      	    MOVE.B	(%A0),%D1
  34 101c B200      	    CMP.B   %D0,%D1
  35 101e 6600 0140 	    BNE.W   FAIL
  36               	
  37               	* BOUNCE A 1 ACROSS THE DATA LINES
  38               	* THIS VERIFIES THERE ARE NO SHORTED DATA LINES
  39               	* ADDRESS LINES COULD STILL HAVE SHORTS/OPENS
  40               	BOUNCE1S:
  41 1022 207C 0030 		MOVE.L  #RAMSTART,%A0
  41      0000 
  42 1028 7001      		MOVEQ   #0x01,%D0
  43               	NEXTONE:
  44 102a 1080      		MOVE.B	%D0,(%A0)
  45 102c 1210      	    MOVE.B  (%A0),%D1
  46 102e B200      	    CMP.B   %D0,%D1
  47 1030 6600 012E 	    BNE.W   FAIL
  48 1034 E380      	    ASL.L   #1,%D0
  49 1036 0C00 0000 	    CMP.B   #0,%D0
  50 103a 66EE      	    BNE.S   NEXTONE
  51               	
68K GAS  ExtRAMTest.s 			page 2


  52               	* BOUNCE A 0 ACROSS THE DATA LINES
  53               	BOUNCE0S:
  54 103c 207C 0030 		MOVE.L  #RAMSTART,%A0
  54      0000 
  55 1042 103C 00FE 		MOVE.B  #0xFE,%D0
  56               	NEXTZERO:
  57 1046 1080      		MOVE.B	%D0,(%A0)
  58 1048 1210      	    MOVE.B  (%A0),%D1
  59 104a B200      	    CMP.B   %D0,%D1
  60 104c 6600 0112 	    BNE.W   FAIL
  61 1050 E318      	    ROL.B   #0x1,%D0
  62 1052 0C00 00FE 	    CMP.B   #0xFE,%D0
  63 1056 66EE      	    BNE.S   NEXTZERO
  64               	
  65               	* CHECK THE UPPER 8 SRAM ADDRESS LINES (A12..A19 ON SRAM)
  66               	* SINCE THERE ARE ONLY 8 DATA LINES THERE CAN ONLY BE 256 UNIQUE DATA PATTERNS
  67               	* WRITE AN INCREMENTING VALUE EVERY 4096 BYTES AND VERIFY
  68 1058 7000      	    MOVEQ   #0x0,%D0
  69 105a 207C 0030 		MOVE.L  #RAMSTART,%A0
  69      0000 
  70 1060 227C 0040 		MOVE.L  #RAMEND+1,%A1
  70      0000 
  71               	FILL4K:
  72 1066 1080      	    MOVE.B  %D0,(%A0)
  73 1068 06B9 0000 	    ADDI.L  #4096,A0
  73      1000 0000 
  73      0000 
  74 1072 B3C8      	    CMP.L   %A0,%A1
  75 1074 6C06      	    BGE.S   DONE4KFL
  76 1076 0600 0001 	    ADDI.B  #0x01,%D0
  77 107a 60EA      	    BRA.S   FILL4K
  78               	DONE4KFL:
  79 107c 7000      	    MOVEQ   #0X00,%D0
  80 107e 207C 0030 		MOVE.L  #RAMSTART,%A0
  80      0000 
  81 1084 227C 0040 		MOVE.L  #RAMEND+1,%A1
  81      0000 
  82               	CHK4K:
  83 108a 1210      	    MOVE.B  (%A0),%D1
  84 108c B200      	    CMP.B   %D0,%D1
  85 108e 6600 00D0 	    BNE.W   FAIL
  86 1092 0600 0001 	    ADDI.B  #0x01,%D0
  87 1096 06B9 0000 	    ADDI.L  #4096,A0
  87      1000 0000 
  87      0000 
  88 10a0 B3C8      	    CMP.L   %A0,%A1
  89 10a2 6C02      	    BGE.S   DONE4K
  90 10a4 60E4      	    BRA.S   CHK4K
  91               	DONE4K:
  92               	
  93               	* CHECK NEXT 4 SRAM ADDRESS LINES (A8..A11 ON SRAM)
  94               	* A12-A19 = 0
  95               	* WRITE AN INCREMENTING VALUE EVERY 256 BYTES AND VERIFY
  96               	* ONLY NEED 16 UNIQUE PATTERNS FOR 4 BITS
  97 10a6 7000      	    MOVEQ   #0x0,%D0
  98 10a8 207C 0030 		MOVE.L  #RAMSTART,%A0
  98      0000 
68K GAS  ExtRAMTest.s 			page 3


  99 10ae 227C 0030 		MOVE.L  #RAMSTART+0x1000,%A1
  99      1000 
 100               	FILL256:
 101 10b4 1080      	    MOVE.B  %D0,(%A0)
 102 10b6 06B9 0000 	    ADDI.L  #256,A0
 102      0100 0000 
 102      0000 
 103 10c0 B3C8      	    CMP.L   %A0,%A1
 104 10c2 6C06      	    BGE.S   DONE256F
 105 10c4 0600 0001 	    ADDI.B  #0x01,%D0
 106 10c8 60EA      	    BRA.S   FILL256
 107               	DONE256F:
 108 10ca 7000      	    MOVEQ   #0X0,%D0
 109 10cc 207C 0030 		MOVE.L  #RAMSTART,%A0
 109      0000 
 110 10d2 227C 0030 		MOVE.L  #RAMSTART+0x1000,%A1
 110      1000 
 111               	CHK256:
 112 10d8 1210      	    MOVE.B  (%A0),%D1
 113 10da B200      	    CMP.B   %D0,%D1
 114 10dc 6600 0082 	    BNE.W   FAIL
 115 10e0 0600 0001 	    ADDI.B  #0x01,%D0
 116 10e4 06B9 0000 	    ADDI.L  #256,A0
 116      0100 0000 
 116      0000 
 117 10ee B3C8      	    CMP.L   %A0,%A1
 118 10f0 6C02      	    BGE.S   DONE256
 119 10f2 60E4      	    BRA.S   CHK256
 120               	DONE256:
 121               	
 122               	* WRITE INCREMENTING PATTERN TO ALL THE SRAM
 123               	* CHECKS THE REMAINING BOTTOM ADDRESSES LINES
 124               	* TOKEN EFFORT TO TOUCH ALL LOCATIONS
 125               	* MAY NOT DETECT INDIVIDUAL STUCK AT HIGH OR LOW BITS INSIDE SRAM
 126 10f4 7000      	    MOVEQ   #0x0,%D0
 127 10f6 207C 0030 		MOVE.L  #RAMSTART,%A0
 127      0000 
 128 10fc 227C 0040 		MOVE.L  #RAMEND+1,%A1
 128      0000 
 129               	CHKALL:
 130 1102 10C0      	    MOVE.B  %D0,(%A0)+
 131 1104 B3C8      	    CMP.L   %A0,%A1
 132 1106 6706      	    BEQ.S   DONEFILL
 133 1108 0600 0001 	    ADDI.B  #0x01,%D0
 134 110c 60F4      	    BRA.S   CHKALL
 135               	DONEFILL:
 136               	* READ BACK INCREMENTING PATTERN 
 137 110e 7000      	    MOVEQ   #0x0,%D0
 138 1110 207C 0030 		MOVE.L  #RAMSTART,%A0
 138      0000 
 139 1116 227C 0040 		MOVE.L  #RAMEND+1,%A1
 139      0000 
 140               	LOOPCHK:
 141 111c 1218      	    MOVE.B  (%A0)+,%D1
 142 111e B200      	    CMP.B   %D0,%D1
 143 1120 6600 003E 	    BNE.W   FAIL
 144 1124 B3C8      	    CMP.L   %A0,%A1
68K GAS  ExtRAMTest.s 			page 4


 145 1126 6706      	    BEQ.S   DONECHK
 146 1128 0600 0001 	    ADDI.B  #0x01,%D0
 147 112c 60EE      	    BRA.S   LOOPCHK
 148               	DONECHK:
 149               	
 150               	* PRINT 'Pass'
 151 112e 103C 000A 		MOVE.B	#0x0A,%D0
 152 1132 4EBA 005E 		JSR     OUTCHAR
 153 1136 103C 000D 		MOVE.B	#0x0D,%D0
 154 113a 4EBA 0056 		JSR     OUTCHAR
 155 113e 103C 0050 		MOVE.B	#'P',%D0
 156 1142 4EBA 004E 		JSR     OUTCHAR
 157 1146 103C 0061 		MOVE.B	#'a',%D0
 158 114a 4EBA 0046 		JSR     OUTCHAR
 159 114e 103C 0073 		MOVE.B	#'s',%D0
 160 1152 4EBA 003E 		JSR     OUTCHAR
 161 1156 103C 0073 		MOVE.B	#'s',%D0
 162 115a 4EBA 0036 		JSR     OUTCHAR
 163 115e 4E75      	    RTS
 164               	FAIL:
 165               	* PRINT 'Fail'
 166 1160 103C 000A 		MOVE.B	#0x0A,%D0
 167 1164 4EBA 002C 		JSR     OUTCHAR
 168 1168 103C 000D 		MOVE.B	#0x0D,%D0
 169 116c 4EBA 0024 		JSR     OUTCHAR
 170 1170 103C 0046 		MOVE.B	#'F',%D0
 171 1174 4EBA 001C 		JSR     OUTCHAR
 172 1178 103C 0061 		MOVE.B	#'a',%D0
 173 117c 4EBA 0014 		JSR     OUTCHAR
 174 1180 103C 0069 		MOVE.B	#'i',%D0
 175 1184 4EBA 000C 		JSR     OUTCHAR
 176 1188 103C 006C 		MOVE.B	#'l',%D0
 177 118c 4EBA 0004 		JSR     OUTCHAR
 178 1190 4E75      		RTS
 179               	
 180               	* OUTPUT A CHARACTER IN D0 TO THE ACIA
 181               	OUTCHAR:
 182 1192 610A      	    BSR.S   WAITRDY
 183 1194 43F9 0001 	    LEA     ACIADATA,%A1
 183      0043 
 184 119a 1280      		MOVE.B	%D0,(%A1)
 185 119c 4E75      	    RTS
 186               	
 187               	* WAIT FOR THE SERIAL PORT TO BE READY
 188               	WAITRDY:
 189 119e 43F9 0001 		LEA     ACIASTAT,%A1
 189      0041 
 190               	LOOPRDY:
 191 11a4 1211      		MOVE.B	(%A1),%D1
 192 11a6 0201 0002 		ANDI.B	#0x2,%D1
 193 11aa 67F8      		BEQ.S   LOOPRDY
 194 11ac 4E75      	    RTS
 195               	
68K GAS  ExtRAMTest.s 			page 5


DEFINED SYMBOLS
        ExtRAMTest.s:12     *ABS*:0000000000300000 RAMSTART
        ExtRAMTest.s:13     *ABS*:00000000003fffff RAMEND
        ExtRAMTest.s:14     *ABS*:0000000000010041 ACIASTAT
        ExtRAMTest.s:15     *ABS*:0000000000010043 ACIADATA
        ExtRAMTest.s:23     .text:0000000000001000 STARTTEST
        ExtRAMTest.s:164    .text:0000000000001160 FAIL
        ExtRAMTest.s:40     .text:0000000000001022 BOUNCE1S
        ExtRAMTest.s:43     .text:000000000000102a NEXTONE
        ExtRAMTest.s:53     .text:000000000000103c BOUNCE0S
        ExtRAMTest.s:56     .text:0000000000001046 NEXTZERO
        ExtRAMTest.s:71     .text:0000000000001066 FILL4K
        ExtRAMTest.s:78     .text:000000000000107c DONE4KFL
        ExtRAMTest.s:82     .text:000000000000108a CHK4K
        ExtRAMTest.s:91     .text:00000000000010a6 DONE4K
        ExtRAMTest.s:100    .text:00000000000010b4 FILL256
        ExtRAMTest.s:107    .text:00000000000010ca DONE256F
        ExtRAMTest.s:111    .text:00000000000010d8 CHK256
        ExtRAMTest.s:120    .text:00000000000010f4 DONE256
        ExtRAMTest.s:129    .text:0000000000001102 CHKALL
        ExtRAMTest.s:135    .text:000000000000110e DONEFILL
        ExtRAMTest.s:140    .text:000000000000111c LOOPCHK
        ExtRAMTest.s:148    .text:000000000000112e DONECHK
        ExtRAMTest.s:181    .text:0000000000001192 OUTCHAR
        ExtRAMTest.s:188    .text:000000000000119e WAITRDY
        ExtRAMTest.s:190    .text:00000000000011a4 LOOPRDY

UNDEFINED SYMBOLS
A0
