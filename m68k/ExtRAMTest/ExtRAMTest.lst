68K GAS  ExtRAMTest.s 			page 1


   1               	* =======================================================================
   2               	* Test the External SRAM on the RETRO-EP4CE15 card
   3               	* The RETRO-EP4CE15 card has 1MB of External SRAM
   4               	* External SRAM only supports 8-bit accesses
   5               	* External SRAM goes from 0x300000 to 0x3FFFFF (1 MB)
   6               	* Test checks the physical connections to the SRAM
   7               	* Test does not exhaustively check the SRAM itself
   8               	* Test takes 2.46 seconds with a 25 MHz 68000 CPU
   9               	* TUTOR14 uses SRAM from 0x000000 to 0x0007FF
  10               	* =======================================================================
  11               	
  12               	RAMSTART	= 0x300000
  13               	RAMEND		= 0x3FFFFF
  14               	ACIASTAT	= 0x010041
  15               	ACIADATA	= 0x010043
  16               	
  17               	TUTORSTART  = 0x008146
  18               	
  19               	* Code follows
  20               	
  21 0000 0000 0000 		.ORG    0x001000
  21      0000 0000 
  21      0000 0000 
  21      0000 0000 
  21      0000 0000 
  22               	* CHECK FIRST LOCATION BY WRITING/READING 0x55/0xAA
  23               	* VERY ROUGH CHECK OF DATA LINES
  24               	* DATA LINES COULD STILL HAVE SHORTS BUT LESS LIKELY SINCE PINS ARE ADJACENT
  25               	STARTTEST:
  26 1000 207C 0030 		MOVE.L  #RAMSTART,%A0
  26      0000 
  27 1006 7055      		MOVEQ   #0x55,%D0
  28 1008 1080      		MOVE.B	%D0,(%A0)
  29 100a 1210      	    MOVE.B	(%A0),%D1
  30 100c B200      	    CMP.B   %D0,%D1
  31 100e 6600 0156 	    BNE.W   FAIL
  32 1012 103C 00AA 		MOVE.B  #0xAA,%D0
  33 1016 1080      		MOVE.B	%D0,(%A0)
  34 1018 4E71      	    NOP
  35 101a 1210      	    MOVE.B	(%A0),%D1
  36 101c B200      	    CMP.B   %D0,%D1
  37 101e 6600 0146 	    BNE.W   FAIL
  38               	
  39               	* BOUNCE A 1 ACROSS THE DATA LINES
  40               	* THIS VERIFIES THERE ARE NO SHORTED DATA LINES
  41               	* ADDRESS LINES COULD STILL HAVE SHORTS/OPENS
  42               	BOUNCE1S:
  43 1022 207C 0030 		MOVE.L  #RAMSTART,%A0
  43      0000 
  44 1028 7001      		MOVEQ   #0x01,%D0
  45               	NEXTONE:
  46 102a 1080      		MOVE.B	%D0,(%A0)
  47 102c 1210      	    MOVE.B  (%A0),%D1
  48 102e B200      	    CMP.B   %D0,%D1
  49 1030 6600 0134 	    BNE.W   FAIL
  50 1034 E380      	    ASL.L   #1,%D0
  51 1036 0C00 0000 	    CMP.B   #0,%D0
68K GAS  ExtRAMTest.s 			page 2


  52 103a 66EE      	    BNE.S   NEXTONE
  53               	
  54               	* BOUNCE A 0 ACROSS THE DATA LINES
  55               	BOUNCE0S:
  56 103c 207C 0030 		MOVE.L  #RAMSTART,%A0
  56      0000 
  57 1042 103C 00FE 		MOVE.B  #0xFE,%D0
  58               	NEXTZERO:
  59 1046 1080      		MOVE.B	%D0,(%A0)
  60 1048 1210      	    MOVE.B  (%A0),%D1
  61 104a B200      	    CMP.B   %D0,%D1
  62 104c 6600 0118 	    BNE.W   FAIL
  63 1050 E318      	    ROL.B   #0x1,%D0
  64 1052 0C00 00FE 	    CMP.B   #0xFE,%D0
  65 1056 66EE      	    BNE.S   NEXTZERO
  66               	
  67               	* CHECK THE UPPER 8 SRAM ADDRESS LINES (A12..A19 ON SRAM)
  68               	* SINCE THERE ARE ONLY 8 DATA LINES THERE CAN ONLY BE 256 UNIQUE DATA PATTERNS
  69               	* WRITE AN INCREMENTING VALUE EVERY 4096 BYTES AND VERIFY
  70 1058 7000      	    MOVEQ   #0x0,%D0
  71 105a 207C 0030 		MOVE.L  #RAMSTART,%A0
  71      0000 
  72 1060 227C 0040 		MOVE.L  #RAMEND+1,%A1
  72      0000 
  73               	FILL4K:
  74 1066 1080      	    MOVE.B  %D0,(%A0)
  75 1068 06B9 0000 	    ADDI.L  #4096,A0
  75      1000 0000 
  75      0000 
  76 1072 B3C8      	    CMP.L   %A0,%A1
  77 1074 6C06      	    BGE.S   DONE4KFL
  78 1076 0600 0001 	    ADDI.B  #0x01,%D0
  79 107a 60EA      	    BRA.S   FILL4K
  80               	DONE4KFL:
  81 107c 7000      	    MOVEQ   #0X00,%D0
  82 107e 207C 0030 		MOVE.L  #RAMSTART,%A0
  82      0000 
  83 1084 227C 0040 		MOVE.L  #RAMEND+1,%A1
  83      0000 
  84               	CHK4K:
  85 108a 1210      	    MOVE.B  (%A0),%D1
  86 108c B200      	    CMP.B   %D0,%D1
  87 108e 6600 00D6 	    BNE.W   FAIL
  88 1092 0600 0001 	    ADDI.B  #0x01,%D0
  89 1096 06B9 0000 	    ADDI.L  #4096,A0
  89      1000 0000 
  89      0000 
  90 10a0 B3C8      	    CMP.L   %A0,%A1
  91 10a2 6C02      	    BGE.S   DONE4K
  92 10a4 60E4      	    BRA.S   CHK4K
  93               	DONE4K:
  94               	
  95               	* CHECK NEXT 4 SRAM ADDRESS LINES (A8..A11 ON SRAM)
  96               	* A12-A19 = 0
  97               	* WRITE AN INCREMENTING VALUE EVERY 256 BYTES AND VERIFY
  98               	* ONLY NEED 16 UNIQUE PATTERNS FOR 4 BITS
  99 10a6 7000      	    MOVEQ   #0x0,%D0
68K GAS  ExtRAMTest.s 			page 3


 100 10a8 207C 0030 		MOVE.L  #RAMSTART,%A0
 100      0000 
 101 10ae 227C 0030 		MOVE.L  #RAMSTART+0x1000,%A1
 101      1000 
 102               	FILL256:
 103 10b4 1080      	    MOVE.B  %D0,(%A0)
 104 10b6 06B9 0000 	    ADDI.L  #256,A0
 104      0100 0000 
 104      0000 
 105 10c0 B3C8      	    CMP.L   %A0,%A1
 106 10c2 6C06      	    BGE.S   DONE256F
 107 10c4 0600 0001 	    ADDI.B  #0x01,%D0
 108 10c8 60EA      	    BRA.S   FILL256
 109               	DONE256F:
 110 10ca 7000      	    MOVEQ   #0X0,%D0
 111 10cc 207C 0030 		MOVE.L  #RAMSTART,%A0
 111      0000 
 112 10d2 227C 0030 		MOVE.L  #RAMSTART+0x1000,%A1
 112      1000 
 113               	CHK256:
 114 10d8 1210      	    MOVE.B  (%A0),%D1
 115 10da B200      	    CMP.B   %D0,%D1
 116 10dc 6600 0088 	    BNE.W   FAIL
 117 10e0 0600 0001 	    ADDI.B  #0x01,%D0
 118 10e4 06B9 0000 	    ADDI.L  #256,A0
 118      0100 0000 
 118      0000 
 119 10ee B3C8      	    CMP.L   %A0,%A1
 120 10f0 6C02      	    BGE.S   DONE256
 121 10f2 60E4      	    BRA.S   CHK256
 122               	DONE256:
 123               	
 124               	* WRITE INCREMENTING PATTERN TO ALL THE SRAM
 125               	* CHECKS THE REMAINING BOTTOM ADDRESSES LINES
 126               	* TOKEN EFFORT TO TOUCH ALL LOCATIONS
 127               	* MAY NOT DETECT INDIVIDUAL STUCK AT HIGH OR LOW BITS INSIDE SRAM
 128 10f4 7000      	    MOVEQ   #0x0,%D0
 129 10f6 207C 0030 		MOVE.L  #RAMSTART,%A0
 129      0000 
 130 10fc 227C 0040 		MOVE.L  #RAMEND+1,%A1
 130      0000 
 131               	CHKALL:
 132 1102 10C0      	    MOVE.B  %D0,(%A0)+
 133 1104 B3C8      	    CMP.L   %A0,%A1
 134 1106 6706      	    BEQ.S   DONEFILL
 135 1108 0600 0001 	    ADDI.B  #0x01,%D0
 136 110c 60F4      	    BRA.S   CHKALL
 137               	DONEFILL:
 138               	* READ BACK INCREMENTING PATTERN 
 139 110e 7000      	    MOVEQ   #0x0,%D0
 140 1110 207C 0030 		MOVE.L  #RAMSTART,%A0
 140      0000 
 141 1116 227C 0040 		MOVE.L  #RAMEND+1,%A1
 141      0000 
 142               	LOOPCHK:
 143 111c 1218      	    MOVE.B  (%A0)+,%D1
 144 111e B200      	    CMP.B   %D0,%D1
68K GAS  ExtRAMTest.s 			page 4


 145 1120 6600 0044 	    BNE.W   FAIL
 146 1124 B3C8      	    CMP.L   %A0,%A1
 147 1126 6706      	    BEQ.S   DONECHK
 148 1128 0600 0001 	    ADDI.B  #0x01,%D0
 149 112c 60EE      	    BRA.S   LOOPCHK
 150               	DONECHK:
 151               	
 152               	* PRINT 'Pass'
 153 112e 103C 000A 		MOVE.B	#0x0A,%D0
 154 1132 4EBA 006A 		JSR     OUTCHAR
 155 1136 103C 000D 		MOVE.B	#0x0D,%D0
 156 113a 4EBA 0062 		JSR     OUTCHAR
 157 113e 103C 0050 		MOVE.B	#'P',%D0
 158 1142 4EBA 005A 		JSR     OUTCHAR
 159 1146 103C 0061 		MOVE.B	#'a',%D0
 160 114a 4EBA 0052 		JSR     OUTCHAR
 161 114e 103C 0073 		MOVE.B	#'s',%D0
 162 1152 4EBA 004A 		JSR     OUTCHAR
 163 1156 103C 0073 		MOVE.B	#'s',%D0
 164 115a 4EBA 0042 		JSR     OUTCHAR
 165 115e 207C 0000 	    MOVE.L	#TUTORSTART,%A0
 165      8146 
 166 1164 4ED0      	    JMP     (%A0)
 167               	
 168               	FAIL:
 169               	* PRINT 'Fail'
 170 1166 103C 000A 		MOVE.B	#0x0A,%D0
 171 116a 4EBA 0032 		JSR     OUTCHAR
 172 116e 103C 000D 		MOVE.B	#0x0D,%D0
 173 1172 4EBA 002A 		JSR     OUTCHAR
 174 1176 103C 0046 		MOVE.B	#'F',%D0
 175 117a 4EBA 0022 		JSR     OUTCHAR
 176 117e 103C 0061 		MOVE.B	#'a',%D0
 177 1182 4EBA 001A 		JSR     OUTCHAR
 178 1186 103C 0069 		MOVE.B	#'i',%D0
 179 118a 4EBA 0012 		JSR     OUTCHAR
 180 118e 103C 006C 		MOVE.B	#'l',%D0
 181 1192 4EBA 000A 		JSR     OUTCHAR
 182 1196 207C 0000 	    MOVE.L	#TUTORSTART,%A0
 182      8146 
 183 119c 4ED0      	    JMP     (%A0)
 184               	
 185               	* OUTPUT A CHARACTER IN D0 TO THE ACIA
 186               	OUTCHAR:
 187 119e 610A      	    BSR.S   WAITRDY
 188 11a0 43F9 0001 	    LEA     ACIADATA,%A1
 188      0043 
 189 11a6 1280      		MOVE.B	%D0,(%A1)
 190 11a8 4E75      	    RTS
 191               	
 192               	* WAIT FOR THE SERIAL PORT TO BE READY
 193               	WAITRDY:
 194 11aa 43F9 0001 		LEA     ACIASTAT,%A1
 194      0041 
 195               	LOOPRDY:
 196 11b0 1211      		MOVE.B	(%A1),%D1
 197 11b2 0201 0002 		ANDI.B	#0x2,%D1
68K GAS  ExtRAMTest.s 			page 5


 198 11b6 67F8      		BEQ.S   LOOPRDY
 199 11b8 4E75      	    RTS
 200               	
68K GAS  ExtRAMTest.s 			page 6


DEFINED SYMBOLS
        ExtRAMTest.s:12     *ABS*:0000000000300000 RAMSTART
        ExtRAMTest.s:13     *ABS*:00000000003fffff RAMEND
        ExtRAMTest.s:14     *ABS*:0000000000010041 ACIASTAT
        ExtRAMTest.s:15     *ABS*:0000000000010043 ACIADATA
        ExtRAMTest.s:17     *ABS*:0000000000008146 TUTORSTART
        ExtRAMTest.s:25     .text:0000000000001000 STARTTEST
        ExtRAMTest.s:168    .text:0000000000001166 FAIL
        ExtRAMTest.s:42     .text:0000000000001022 BOUNCE1S
        ExtRAMTest.s:45     .text:000000000000102a NEXTONE
        ExtRAMTest.s:55     .text:000000000000103c BOUNCE0S
        ExtRAMTest.s:58     .text:0000000000001046 NEXTZERO
        ExtRAMTest.s:73     .text:0000000000001066 FILL4K
        ExtRAMTest.s:80     .text:000000000000107c DONE4KFL
        ExtRAMTest.s:84     .text:000000000000108a CHK4K
        ExtRAMTest.s:93     .text:00000000000010a6 DONE4K
        ExtRAMTest.s:102    .text:00000000000010b4 FILL256
        ExtRAMTest.s:109    .text:00000000000010ca DONE256F
        ExtRAMTest.s:113    .text:00000000000010d8 CHK256
        ExtRAMTest.s:122    .text:00000000000010f4 DONE256
        ExtRAMTest.s:131    .text:0000000000001102 CHKALL
        ExtRAMTest.s:137    .text:000000000000110e DONEFILL
        ExtRAMTest.s:142    .text:000000000000111c LOOPCHK
        ExtRAMTest.s:150    .text:000000000000112e DONECHK
        ExtRAMTest.s:186    .text:000000000000119e OUTCHAR
        ExtRAMTest.s:193    .text:00000000000011aa WAITRDY
        ExtRAMTest.s:195    .text:00000000000011b0 LOOPRDY

UNDEFINED SYMBOLS
A0
