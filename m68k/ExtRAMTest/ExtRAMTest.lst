68K GAS  ExtRAMTest.s 			page 1


   1               	* =======================================================================
   2               	* Test the External SRAM on the RETRO-EP4CE15 card
   3               	* The RETRO-EP4CE15 card has 1MB of External SRAM
   4               	* External SRAM only supports 8-bit accesses
   5               	* External SRAM goes from 0x300000 to 0x3FFFFF (1 MB)
   6               	* Test checks the physical connections to the SRAM
   7               	* Test does not exhaustively check the SRAM itself
   8               	* Test takes several seconds with a 25 MHz 68000 CPU
   9               	* TUTOR14 uses SRAM from 0x000000 to 0x000800
  10               	* =======================================================================
  11               	
  12               	RAMSTART	= 0x300000
  13               	RAMEND		= 0x3FFFFF
  14               	ACIASTAT	= 0x010041
  15               	ACIADATA	= 0x010043
  16               	
  17               	* Code follows
  18               	
  19 0000 0000 0000 		.ORG    0x001000
  19      0000 0000 
  19      0000 0000 
  19      0000 0000 
  19      0000 0000 
  20               	* CHECK FIRST LOCATION BY WRITING/READING 0x55/0xAA
  21               	* VERY ROUGH CHECK OF DATA LINES
  22               	* DATA LINES COULD STILL HAVE SHORTS BUT LESS LIKELY SINCE PINS ARE ADJACENT
  23               	STARTTEST:
  24 1000 207C 0030 		MOVE.L  #RAMSTART,%A0
  24      0000 
  25 1006 103C 0055 		MOVE.B  #0x55,%D0
  26 100a 1080      		MOVE.B	%D0,(%A0)
  27 100c 1210      	    MOVE.B	(%A0),%D1
  28 100e B200      	    CMP.B   %D0,%D1
  29 1010 6600 016E 	    BNE     FAIL
  30 1014 103C 00AA 		MOVE.B  #0xAA,%D0
  31 1018 1080      		MOVE.B	%D0,(%A0)
  32 101a 4E71      	    NOP
  33 101c 1210      	    MOVE.B	(%A0),%D1
  34 101e B200      	    CMP.B   %D0,%D1
  35 1020 6600 015E 	    BNE     FAIL
  36               	
  37               	* BOUNCE A 1 ACROSS THE DATA LINES
  38               	* THIS VERIFIES THERE ARE NO SHORTED DATA LINES
  39               	* ADDRESS LINES COULD STILL HAVE SHORTS/OPENS
  40               	BOUNCE1S:
  41 1024 207C 0030 		MOVE.L  #RAMSTART,%A0
  41      0000 
  42 102a 103C 0001 		MOVE.B  #0x01,%D0
  43               	NEXTONE:
  44 102e 1080      		MOVE.B	%D0,(%A0)
  45 1030 1210      	    MOVE.B  (%A0),%D1
  46 1032 B200      	    CMP.B   %D0,%D1
  47 1034 6600 014A 	    BNE     FAIL
  48 1038 E380      	    ASL.L   #1,%D0
  49 103a 0C00 0000 	    CMP.B   #0,%D0
  50 103e 6600 FFEE 	    BNE     NEXTONE
  51               	
68K GAS  ExtRAMTest.s 			page 2


  52               	* BOUNCE A 0 ACROSS THE DATA LINES
  53               	BOUNCE0S:
  54 1042 207C 0030 		MOVE.L  #RAMSTART,%A0
  54      0000 
  55 1048 103C 00FE 		MOVE.B  #0xFE,%D0
  56               	NEXTZERO:
  57 104c 1080      		MOVE.B	%D0,(%A0)
  58 104e 1210      	    MOVE.B  (%A0),%D1
  59 1050 B200      	    CMP.B   %D0,%D1
  60 1052 6600 012C 	    BNE     FAIL
  61 1056 E380      	    ASL.L   #0x01,%D0
  62 1058 0000 0001 	    ORI.B   #0x01,%D0
  63 105c 0C00 00FF 	    CMP.B   #0XFF,%D0
  64 1060 6600 FFEA 	    BNE     NEXTZERO
  65               	
  66               	* CHECK THE UPPER 8 SRAM ADDRESS LINES (A12..A19 ON SRAM)
  67               	* SINCE THERE ARE ONLY 8 DATA LINES THERE CAN ONLY BE 256 UNIQUE DATA PATTERNS
  68               	* WRITE AN INCREMENTING VALUE EVERY 4096 BYTES AND VERIFY
  69 1064 103C 0000 	    MOVE.B  #0X00,%D0
  70 1068 207C 0030 		MOVE.L  #RAMSTART,%A0
  70      0000 
  71 106e 227C 0040 		MOVE.L  #RAMEND+1,%A1
  71      0000 
  72               	FILL4K:
  73 1074 1080      	    MOVE.B  %D0,(%A0)
  74 1076 06B9 0000 	    ADDI.L  #4096,A0
  74      1000 0000 
  74      0000 
  75 1080 B3C8      	    CMP.L   %A0,%A1
  76 1082 6C08      	    BGE.S   DONE4KFL
  77 1084 0600 0001 	    ADDI.B  #0x01,%D0
  78 1088 6000 FFEA 	    BRA     FILL4K
  79               	DONE4KFL:
  80 108c 103C 0000 	    MOVE.B  #0X00,%D0
  81 1090 207C 0030 		MOVE.L  #RAMSTART,%A0
  81      0000 
  82 1096 227C 0040 		MOVE.L  #RAMEND+1,%A1
  82      0000 
  83               	CHK4K:
  84 109c 1210      	    MOVE.B  (%A0),%D1
  85 109e B200      	    CMP.B   %D0,%D1
  86 10a0 6600 00DE 	    BNE     FAIL
  87 10a4 0600 0001 	    ADDI.B  #0x01,%D0
  88 10a8 06B9 0000 	    ADDI.L  #4096,A0
  88      1000 0000 
  88      0000 
  89 10b2 B3C8      	    CMP.L   %A0,%A1
  90 10b4 6C04      	    BGE.S   DONE4K
  91 10b6 6000 FFE4 	    BRA     CHK4K
  92               	DONE4K:
  93               	
  94               	* CHECK NEXT 4 SRAM ADDRESS LINES (A8..A11 ON SRAM)
  95               	* A12-A19 = 0
  96               	* WRITE AN INCREMENTING VALUE EVERY 256 BYTES AND VERIFY
  97               	* ONLY NEED 16 UNIQUE PATTERNS FOR 4 BITS
  98 10ba 103C 0000 	    MOVE.B  #0X00,%D0
  99 10be 207C 0030 		MOVE.L  #RAMSTART,%A0
68K GAS  ExtRAMTest.s 			page 3


  99      0000 
 100 10c4 227C 0030 		MOVE.L  #RAMSTART+0x1000,%A1
 100      1000 
 101               	FILL256:
 102 10ca 1080      	    MOVE.B  %D0,(%A0)
 103 10cc 06B9 0000 	    ADDI.L  #256,A0
 103      0100 0000 
 103      0000 
 104 10d6 B3C8      	    CMP.L   %A0,%A1
 105 10d8 6C08      	    BGE.S   DONE256F
 106 10da 0600 0001 	    ADDI.B  #0x01,%D0
 107 10de 6000 FFEA 	    BRA     FILL256
 108               	DONE256F:
 109 10e2 103C 0000 	    MOVE.B  #0X00,%D0
 110 10e6 207C 0030 		MOVE.L  #RAMSTART,%A0
 110      0000 
 111 10ec 227C 0030 		MOVE.L  #RAMSTART+0x1000,%A1
 111      1000 
 112               	CHK256:
 113 10f2 1210      	    MOVE.B  (%A0),%D1
 114 10f4 B200      	    CMP.B   %D0,%D1
 115 10f6 6600 0088 	    BNE     FAIL
 116 10fa 0600 0001 	    ADDI.B  #0x01,%D0
 117 10fe 06B9 0000 	    ADDI.L  #256,A0
 117      0100 0000 
 117      0000 
 118 1108 B3C8      	    CMP.L   %A0,%A1
 119 110a 6C04      	    BGE.S   DONE256
 120 110c 6000 FFE4 	    BRA     CHK256
 121               	DONE256:
 122               	
 123               	* WRITE INCREMENTING PATTERN TO ALL THE SRAM
 124               	* CHECKS THE REMAINING BOTTOM ADDRESSES LINES
 125               	* TOKEN EFFORT TO TOUCH ALL LOCATIONS
 126               	* MAY NOT DETECT INDIVIDUAL STUCK AT HIGH OR LOW BITS INSIDE SRAM
 127 1110 103C 0000 	    MOVE.B  #0X00,%D0
 128 1114 207C 0030 		MOVE.L  #RAMSTART,%A0
 128      0000 
 129 111a 227C 0040 		MOVE.L  #RAMEND+1,%A1
 129      0000 
 130               	CHKALL:
 131 1120 10C0      	    MOVE.B  %D0,(%A0)+
 132 1122 B3C8      	    CMP.L   %A0,%A1
 133 1124 6706      	    BEQ.S   DONEFILL
 134 1126 0600 0001 	    ADDI.B  #0x01,%D0
 135 112a 60F4      	    BRA.S   CHKALL
 136               	DONEFILL:
 137               	* READ BACK INCREMENTING PATTERN 
 138 112c 103C 0000 	    MOVE.B  #0X00,%D0
 139 1130 207C 0030 		MOVE.L  #RAMSTART,%A0
 139      0000 
 140 1136 227C 0040 		MOVE.L  #RAMEND+1,%A1
 140      0000 
 141               	LOOPCHK:
 142 113c 1218      	    MOVE.B  (%A0)+,%D1
 143 113e B200      	    CMP.B   %D0,%D1
 144 1140 6600 003E 	    BNE     FAIL
68K GAS  ExtRAMTest.s 			page 4


 145 1144 B3C8      	    CMP.L   %A0,%A1
 146 1146 6706      	    BEQ.S   DONECHK
 147 1148 0600 0001 	    ADDI.B  #0x01,%D0
 148 114c 60EE      	    BRA.S   LOOPCHK
 149               	DONECHK:
 150               	
 151               	* PRINT 'Pass'
 152 114e 103C 000A 		MOVE.B	#0x0A,%D0
 153 1152 4EBA 005E 		JSR     OUTCHAR
 154 1156 103C 000D 		MOVE.B	#0x0D,%D0
 155 115a 4EBA 0056 		JSR     OUTCHAR
 156 115e 103C 0050 		MOVE.B	#'P',%D0
 157 1162 4EBA 004E 		JSR     OUTCHAR
 158 1166 103C 0061 		MOVE.B	#'a',%D0
 159 116a 4EBA 0046 		JSR     OUTCHAR
 160 116e 103C 0073 		MOVE.B	#'s',%D0
 161 1172 4EBA 003E 		JSR     OUTCHAR
 162 1176 103C 0073 		MOVE.B	#'s',%D0
 163 117a 4EBA 0036 		JSR     OUTCHAR
 164 117e 4E75      	    RTS
 165               	FAIL:
 166               	* PRINT 'Fail'
 167 1180 103C 000A 		MOVE.B	#0x0A,%D0
 168 1184 4EBA 002C 		JSR     OUTCHAR
 169 1188 103C 000D 		MOVE.B	#0x0D,%D0
 170 118c 4EBA 0024 		JSR     OUTCHAR
 171 1190 103C 0046 		MOVE.B	#'F',%D0
 172 1194 4EBA 001C 		JSR     OUTCHAR
 173 1198 103C 0061 		MOVE.B	#'a',%D0
 174 119c 4EBA 0014 		JSR     OUTCHAR
 175 11a0 103C 0069 		MOVE.B	#'i',%D0
 176 11a4 4EBA 000C 		JSR     OUTCHAR
 177 11a8 103C 006C 		MOVE.B	#'l',%D0
 178 11ac 4EBA 0004 		JSR     OUTCHAR
 179 11b0 4E75      		RTS
 180               	
 181               	* OUTPUT A CHARACTER IN D0 TO THE ACIA
 182               	OUTCHAR:
 183 11b2 610A      	    BSR.S   WAITRDY
 184 11b4 43F9 0001 	    LEA     ACIADATA,%A1
 184      0043 
 185 11ba 1280      		MOVE.B	%D0,(%A1)
 186 11bc 4E75      	    RTS
 187               	
 188               	* WAIT FOR THE SERIAL PORT TO BE READY
 189               	WAITRDY:
 190 11be 43F9 0001 		LEA     ACIASTAT,%A1
 190      0041 
 191               	LOOPRDY:
 192 11c4 1211      		MOVE.B	(%A1),%D1
 193 11c6 0201 0002 		ANDI.B	#0x2,%D1
 194 11ca 67F8      		BEQ.S   LOOPRDY
 195 11cc 4E75      	    RTS
 196               	
68K GAS  ExtRAMTest.s 			page 5


DEFINED SYMBOLS
        ExtRAMTest.s:12     *ABS*:0000000000300000 RAMSTART
        ExtRAMTest.s:13     *ABS*:00000000003fffff RAMEND
        ExtRAMTest.s:14     *ABS*:0000000000010041 ACIASTAT
        ExtRAMTest.s:15     *ABS*:0000000000010043 ACIADATA
        ExtRAMTest.s:23     .text:0000000000001000 STARTTEST
        ExtRAMTest.s:165    .text:0000000000001180 FAIL
        ExtRAMTest.s:40     .text:0000000000001024 BOUNCE1S
        ExtRAMTest.s:43     .text:000000000000102e NEXTONE
        ExtRAMTest.s:53     .text:0000000000001042 BOUNCE0S
        ExtRAMTest.s:56     .text:000000000000104c NEXTZERO
        ExtRAMTest.s:72     .text:0000000000001074 FILL4K
        ExtRAMTest.s:79     .text:000000000000108c DONE4KFL
        ExtRAMTest.s:83     .text:000000000000109c CHK4K
        ExtRAMTest.s:92     .text:00000000000010ba DONE4K
        ExtRAMTest.s:101    .text:00000000000010ca FILL256
        ExtRAMTest.s:108    .text:00000000000010e2 DONE256F
        ExtRAMTest.s:112    .text:00000000000010f2 CHK256
        ExtRAMTest.s:121    .text:0000000000001110 DONE256
        ExtRAMTest.s:130    .text:0000000000001120 CHKALL
        ExtRAMTest.s:136    .text:000000000000112c DONEFILL
        ExtRAMTest.s:141    .text:000000000000113c LOOPCHK
        ExtRAMTest.s:149    .text:000000000000114e DONECHK
        ExtRAMTest.s:182    .text:00000000000011b2 OUTCHAR
        ExtRAMTest.s:189    .text:00000000000011be WAITRDY
        ExtRAMTest.s:191    .text:00000000000011c4 LOOPRDY

UNDEFINED SYMBOLS
A0
